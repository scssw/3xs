{{define "modals/clientsModal"}}
<a-modal id="client-modal" v-model="clientModal.visible" :title="clientModal.title" @ok="clientModal.ok"
         :confirm-loading="clientModal.confirmLoading" :closable="true" :mask-closable="false"
         :class="themeSwitcher.currentTheme"
         :ok-text="clientModal.okText" cancel-text='{{ i18n "close" }}'>
    <template v-if="isEdit">
        <a-tag v-if="isExpiry || isTrafficExhausted" color="red" :style="{ marginBottom: '10px', display: 'block', textAlign: 'center' }">Account is (Expired|Traffic Ended) And Disabled</a-tag>
    </template>
    {{template "form/client"}}
</a-modal>
<script>

    const CLIENT_TRAFFIC_EXPIRY_MAP = new Map([
        [50, 1],
        [150, 3],
        [300, 6],
        [600, 12],
    ]);

    const clientModal = {
        visible: false,
        confirmLoading: false,
        title: '',
        okText: '',
        isEdit: false,
        dbInbound: new DBInbound(),
        inbound: new Inbound(),
        clients: [],
        clientStats: [],
        oldClientId: "",
        index: null,
        clientIps: null,
        delayedStart: false,
        ok() {
            if (clientModal.isEdit) {
                ObjectUtil.execute(clientModal.confirm, clientModalApp.client, clientModal.dbInbound.id, clientModal.oldClientId);
            } else {
                ObjectUtil.execute(clientModal.confirm, clientModalApp.client, clientModal.dbInbound.id);
            }
        },
        show({ title = '', okText = '{{ i18n "sure" }}', index = null, dbInbound = null, confirm = () => { }, isEdit = false }) {
            this.visible = true;
            this.title = title;
            this.okText = okText;
            this.isEdit = isEdit;
            this.dbInbound = new DBInbound(dbInbound);
            this.inbound = dbInbound.toInbound();
            this.clients = this.inbound.clients;
            this.index = index === null ? this.clients.length : index;
            this.delayedStart = false;
            if (isEdit) {
                if (this.clients[index].expiryTime < 0) {
                    this.delayedStart = true;
                }
                this.oldClientId = this.getClientId(dbInbound.protocol, clients[index]);
            } else {
                this.addClient(this.inbound, this.clients);
            }
            this.clientStats = this.dbInbound.clientStats.find(row => row.email === this.clients[this.index].email);
            this.confirm = confirm;
        },  
        getClientId(protocol, client) {
            switch (protocol) {
                case Protocols.TROJAN: return client.password;
                case Protocols.SHADOWSOCKS: return client.email;
                default: return client.id;
            }
        },
        addClient(inbound, clients) {
            switch (inbound.protocol) {
                case Protocols.VMESS: return clients.push(new Inbound.VmessSettings.VMESS());
                case Protocols.VLESS: return clients.push(new Inbound.VLESSSettings.VLESS());
                case Protocols.TROJAN: return clients.push(new Inbound.TrojanSettings.Trojan());
                case Protocols.SHADOWSOCKS: return clients.push(new Inbound.ShadowsocksSettings.Shadowsocks(clients[0].method, RandomUtil.randomShadowsocksPassword(inbound.settings.method)));
                default: return null;
            }
        },
        close() {
            clientModal.visible = false;
            clientModal.loading(false);
        },
        loading(loading=true) {
            clientModal.confirmLoading = loading;
        },
    };

    const clientModalApp = new Vue({
        delimiters: ['[[', ']]'],
        el: '#client-modal',
        data: {
            clientModal,
            get inbound() {
                return this.clientModal.inbound;
            },
            get client() {
                return this.clientModal.clients[this.clientModal.index];
            },
            get clientTotalGB() {
                return this.client ? this.client._totalGB : null;
            },
            get clientExpiryTime() {
                return this.client ? this.client._expiryTime : null;
            },
            get isSinglePortMultiUser() {
                return this.clientModal.dbInbound && this.clientModal.dbInbound.total === 0 && this.clientModal.dbInbound.expiryTime === 0;
            },
            get clientStats() {
                return this.clientModal.clientStats;
            },
            get isEdit() {
                return this.clientModal.isEdit;
            },
            get datepicker() {
                return app.datepicker;
            },
            get isTrafficExhausted() {
                if (!clientStats) return false
                if (clientStats.total <= 0) return false
                if (clientStats.up + clientStats.down < clientStats.total) return false
                return true
            },
            get isExpiry() {
                return this.clientModal.isEdit && this.client.expiryTime >0 ? (this.client.expiryTime < new Date().getTime()) : false;
            },
            get delayedStart() {
                return this.clientModal.delayedStart;
            },
            set delayedStart(value) {
                this.clientModal.delayedStart = value;
            },
            get delayedExpireDays() {
                return this.client && this.client.expiryTime < 0 ? this.client.expiryTime / -86400000 : 0;
            },
            set delayedExpireDays(days) {
                this.client.expiryTime = -86400000 * days;
            },
        },
        watch: {
            'clientModal.visible'(isVisible) {
                if (!isVisible) return;
                if (this.isEdit) return;
                this.applyClientDefaults();
            },
            'clientModal.inbound.port'() {
                this.applyClientEmailDefault();
            },
            'clientModal.dbInbound.totalGB'() {
                if (this.isEdit) return;
                if (this.isSinglePortMultiUser) return;
                this.applyClientDefaults();
            },
            'clientModal.dbInbound._expiryTime'() {
                if (this.isEdit) return;
                if (this.isSinglePortMultiUser) return;
                this.applyClientDefaults();
            },
            clientTotalGB(newVal) {
                if (this.isEdit) return;
                if (!this.isSinglePortMultiUser) return;
                this.applyClientExpiryRule(newVal);
            },
            clientExpiryTime() {
                this.applyClientEmailDefault();
            },
        },
        methods: {
            getTrafficExpiryMonths(totalGB) {
                const normalized = Number(totalGB);
                if (!Number.isFinite(normalized)) return null;
                return CLIENT_TRAFFIC_EXPIRY_MAP.get(normalized) ?? null;
            },
            getHostPrefix() {
                const host = (window.location && window.location.hostname) ? window.location.hostname : '';
                if (!host) return 'HOST';
                return host.split('.')[0].split(':')[0].toUpperCase();
            },
            getExpiryLabel(expiryTime) {
                if (!expiryTime) return '0.0';
                if (typeof moment !== 'undefined' && moment.isMoment(expiryTime)) {
                    return `${expiryTime.month() + 1}.${expiryTime.date()}`;
                }
                const dateValue = typeof expiryTime === 'number' ? expiryTime : new Date(expiryTime).getTime();
                if (!Number.isFinite(dateValue)) return '0.0';
                const date = new Date(dateValue);
                return `${date.getMonth() + 1}.${date.getDate()}`;
            },
            applyClientExpiryRule(totalGB) {
                if (this.isEdit) return;
                const months = this.getTrafficExpiryMonths(totalGB);
                if (!months || typeof moment === 'undefined') return;
                this.client._expiryTime = moment().add(months, 'months');
                this.applyClientEmailDefault();
            },
            applyClientEmailDefault() {
                if (this.isEdit) return;
                if (!this.client) return;
                const prefix = this.getHostPrefix();
                const port = this.inbound ? this.inbound.port : '';
                const expirySource = this.isSinglePortMultiUser ? this.client._expiryTime : this.clientModal.dbInbound._expiryTime;
                const expiryLabel = this.getExpiryLabel(expirySource);
                this.client.email = `${prefix}:${port}-${expiryLabel}`;
            },
            applyClientDefaults() {
                if (!this.client) return;
                if (this.isSinglePortMultiUser) {
                    this.client._totalGB = 50;
                    this.applyClientExpiryRule(50);
                } else {
                    const inboundTotal = Number.isFinite(this.clientModal.dbInbound.totalGB) ? this.clientModal.dbInbound.totalGB : 0;
                    this.client._totalGB = inboundTotal;
                    this.client._expiryTime = this.clientModal.dbInbound._expiryTime || null;
                    this.applyClientEmailDefault();
                }
            },
            async getDBClientIps(email) {
                const msg = await HttpUtil.post(`/panel/api/inbounds/clientIps/${email}`);
                if (!msg.success) {
                    document.getElementById("clientIPs").value = msg.obj;
                    return;
                }
                let ips = msg.obj;
                if (typeof ips === 'string' && ips.startsWith('[') && ips.endsWith(']')) {
                    try {
                        ips = JSON.parse(ips);
                        ips = Array.isArray(ips) ? ips.join("\n") : ips;
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                    }
                }
                document.getElementById("clientIPs").value = ips;
            },
            async clearDBClientIps(email) {
                try {
                    const msg = await HttpUtil.post(`/panel/api/inbounds/clearClientIps/${email}`);
                    if (!msg.success) {
                        return;
                    }
                    document.getElementById("clientIPs").value = "";
                } catch (error) {
                }
            },
            resetClientTraffic(email, dbInboundId, iconElement) {
                this.$confirm({
                    title: '{{ i18n "pages.inbounds.resetTraffic"}}',
                    content: '{{ i18n "pages.inbounds.resetTrafficContent"}}',
                    class: themeSwitcher.currentTheme,
                    okText: '{{ i18n "reset"}}',
                    cancelText: '{{ i18n "cancel"}}',
                    onOk: async () => {
                        iconElement.disabled = true;
                        const msg = await HttpUtil.postWithModal('/panel/api/inbounds/' + dbInboundId + '/resetClientTraffic/' + email);
                        if (msg.success) {
                            this.clientModal.clientStats.up = 0;
                            this.clientModal.clientStats.down = 0;
                        }
                        iconElement.disabled = false;
                    },
                })
            },
        },
    });

</script>
{{end}}
